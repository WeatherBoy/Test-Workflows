<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Diabetes Consultation – {{ patient.name_or_alias }}</title>
  <!-- Plotly JS (we keep charts' JS out of the Python divs and load it here) -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    :root {
      --bg: #0b0e14;
      --panel: #11151d;
      --muted: #9aa4b2;
      --text: #e7edf3;
      --accent: #6ea8fe;
      --warn: #ffb86b;
      --ok: #7bd389;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 80% 0%, #0e1320, #0b0e14 60%);
      color: var(--text);
    }
    .container {
      max-width: 1200px;
      margin: 24px auto 64px;
      padding: 0 16px;
    }
    .header {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      align-items: end;
      margin-bottom: 16px;
    }
    h1 {
      font-size: 24px;
      margin: 0;
      letter-spacing: 0.3px;
    }
    .idline {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }
    .metrics {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .metric {
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 10px 12px;
      min-width: 110px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
    }
    .metric .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .metric .value {
      font-weight: 600;
      font-size: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 16px;
    }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      backdrop-filter: blur(6px);
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 16px;
      letter-spacing: 0.2px;
    }
    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    ul, ol {
      margin: 0 0 0 18px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px dashed rgba(255,255,255,0.1);
      padding: 8px 6px;
      vertical-align: top;
    }
    th {
      text-align: left;
      color: var(--muted);
      font-weight: 500;
      letter-spacing: 0.02em;
    }
    .footer-note {
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
    }
    .subtle {
      color: var(--muted);
      font-size: 13px;
      margin: 4px 0 0;
    }
    .callout {
      border-left: 3px solid var(--accent);
      padding-left: 10px;
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .split { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>Consultation overview – {{ patient.name_or_alias }}</h1>
        <div class="idline">ID: {{ patient.patient_id }} · Diabetes: {{ patient.dm_type }}</div>
      </div>
      <div class="metrics">
        {% if patient.hba1c is defined and patient.hba1c is not none %}
        <div class="metric">
          <div class="label">HbA1c</div>
          <div class="value">{{ "%.1f"|format(patient.hba1c) }}%</div>
        </div>
        {% endif %}
        <div class="metric">
          <div class="label">Type</div>
          <div class="value">{{ patient.dm_type }}</div>
        </div>
        <div class="metric">
          <div class="label">Age</div>
          <div class="value">{{ patient.age }}</div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Struggle profile</h2>
        {{ radar_div|safe }}
        <div class="subtle">Scale 0–10 (10 = major struggle). Use for quick orientation; see notes for nuance.</div>
      </div>

      <div class="card">
        <h2>Top focus areas</h2>
        {{ bar_div|safe }}
        <div class="callout">Tip: Start with 1–2 behavior targets (e.g., late snacking routine; medication reminder).</div>
      </div>
    </div>

    <div class="split" style="margin-top:16px;">
      <div class="card">
        <h2>Patient voice – highlights</h2>
        <ul>
          {% for q in patient.highlights %}
          <li>{{ q }}</li>
          {% endfor %}
        </ul>
        <div class="footer-note">Short quotes help anchor goals in the patient's own words.</div>
      </div>

      <div class="card">
        <h2>Action flags</h2>
        <ul>
          {% for k, v in patient.flags.items() %}
            <li><strong>{{ k }}:</strong>
              {% if v is sameas true %}Yes
              {% elif v is sameas false %}No
              {% else %}{{ v }}
              {% endif %}
            </li>
          {% endfor %}
        </ul>
        <div class="footer-note">Mark what's actionable this visit vs. to queue for referrals/follow-up.</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h2>Domain notes</h2>
      <table>
        <thead>
          <tr><th>Domain</th><th>Score</th><th>Note</th></tr>
        </thead>
        <tbody>
          {% for lbl, score, note in patient.domains %}
          <tr>
            <td>{{ lbl }}</td>
            <td>{{ "%.1f"|format(score) }}</td>
            <td>{{ note }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="footer-note">
      Prototype. Not for clinical decision-making. Replace sample data in your Python loader.
    </div>
  </div>
</body>
</html>
